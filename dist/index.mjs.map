{"version":3,"file":"index.mjs","names":[],"sources":["../src/utils.ts","../src/options.ts","../src/express/helpers.ts","../src/express/createMiddleware.ts","../src/index.ts"],"sourcesContent":["// vite-uni-rpc/src/utils.ts\nimport { readdir } from \"node:fs/promises\";\nimport { join } from \"node:path\";\nimport process from \"node:process\";\nimport type { ResolvedConfig, ViteDevServer } from \"vite\";\nimport type {\n  RpcPluginOptions,\n  ServerFnEntry,\n  ServerFunction,\n  ServerFunctionOptions,\n} from \"./types.d.ts\";\n\nexport const serverFunctionsMap = new Map<string, ServerFunction>();\n\nexport const functionMappings = new Map<string, string>();\n\ntype ScanConfig = Pick<ResolvedConfig, \"root\" | \"base\"> & {\n  server?: Partial<ResolvedConfig[\"server\"]>;\n};\n\nexport const scanForServerFiles = async (\n  initialCfg?: ScanConfig,\n  devServer?: ViteDevServer,\n) => {\n  functionMappings.clear();\n  let server = devServer;\n  const config =\n    (!initialCfg && !devServer) || !initialCfg\n      ? {\n          // always scan relative to the real root\n          root: process.cwd(),\n          base: process.env.BASE || \"/\",\n          server: { middlewareMode: true },\n        }\n      : {\n          ...initialCfg,\n          // always scan relative to the real root\n          root: process.cwd(),\n        };\n\n  if (!server) {\n    const { createServer } = await import(\"vite\");\n    server = await createServer({\n      server: config.server,\n      appType: \"custom\",\n      base: config.base,\n      root: config.root,\n    });\n  }\n\n  const svFiles = [\"server.ts\", \"server.js\", \"server.mjs\", \"server.mts\"];\n  const apiDir = join(config.root, \"src\", \"api\");\n  const files = (await readdir(apiDir, { withFileTypes: true }))\n    .filter((f) => svFiles.some((fn) => f.name.includes(fn)))\n    .map((f) => join(apiDir, f.name));\n\n  for (const file of files) {\n    try {\n      // Transform TypeScript to JavaScript using the loaded transform function\n      const moduleExports = (await server.ssrLoadModule(file)) as Record<\n        string,\n        ServerFnEntry\n      >;\n      const moduleEntries = Object.entries(moduleExports);\n      if (!moduleEntries.length) {\n        console.warn(\"No server function found.\");\n        // Remember to always close the temporary dev server!\n        if (!devServer) {\n          server.close();\n        }\n        return;\n      }\n\n      // Examine each export\n      for (const [exportName, exportValue] of moduleEntries) {\n        for (const [registeredName, serverFn] of serverFunctionsMap.entries()) {\n          if (serverFn.name === registeredName && serverFn.fn === exportValue) {\n            functionMappings.set(registeredName, exportName);\n          }\n        }\n      }\n      // Remember to always close the temporary dev server!\n      if (!devServer) {\n        server.close();\n      }\n    } catch (error) {\n      console.error(\"Error loading file:\", file, error);\n    }\n  }\n};\n\nconst getModule = (\n  fnName: string,\n  fnEntry: string,\n  options: Partial<ServerFunctionOptions> & {\n    contentType: ServerFunctionOptions[\"contentType\"];\n    rpcPreffix: string;\n  },\n) => {\n  let bodyHandling;\n  switch (options.contentType) {\n    case \"text/plain\":\n      bodyHandling = `\n    const body = args[0];\n    const headers = {\n      'Content-Type': 'text/plain'\n    };`;\n      break;\n    default:\n      bodyHandling = `\n    const body = JSON.stringify(args);\n    const headers = {\n      'Content-Type': 'application/json'\n    };`;\n  }\n\n  return `\n  export const ${fnEntry} = async function ${fnEntry}(...args) {\n  // export const ${fnEntry} = async (...args) => {\n    const controller = new AbortController();\n    this.cancel = () => controller.abort();\n    ${bodyHandling}\n    const response = await fetch('/${options.rpcPreffix}/${fnName}', {\n      method: 'POST',\n      headers: headers,\n      credentials: 'include',\n      body: body,\n      signal: controller.signal,\n    });\n    return await handleResponse(response);\n  }`;\n};\n\nexport const getClientModules = (initialOptions: RpcPluginOptions) => {\n  return `\n// Client-side RPC modules\nconst handleResponse = async (response) => {\n  if (!response.ok) throw new Error('Fetch error: ' + response.statusText);\n  const result = await response.json();\n  if (result.error) throw new Error(result.error);\n  return result.data;\n}\n${Array.from(functionMappings.entries())\n  .map(([registeredName, exportName]) =>\n    getModule(registeredName, exportName, {\n      ...initialOptions,\n      ...((serverFunctionsMap.get(registeredName)\n        ?.options as ServerFunctionOptions) || {}),\n    }),\n  )\n  .join(\"\\n\")}\n`.trim();\n};\n","import type {\n  MiddlewareOptions,\n  RpcPluginOptions,\n  ServerFunctionOptions,\n} from \"./types.d.ts\";\n\nexport const defaultServerFnOptions = {\n  contentType: \"application/json\",\n  ttl: 10 * 1000, // 10s\n  invalidateKeys: [],\n} satisfies ServerFunctionOptions;\n\nexport const defaultRPCOptions = {\n  rpcPreffix: \"__rpc\",\n  adapter: \"express\",\n  headers: undefined,\n  onError: undefined,\n  onRequest: undefined,\n  onResponse: undefined,\n} satisfies RpcPluginOptions;\n\nexport const defaultMiddlewareOptions = {\n  // rpcPreffix: defaultRPCOptions.rpcPreffix,\n  rpcPreffix: undefined,\n  path: undefined,\n  headers: {} as Record<string, string>,\n  handler: undefined,\n  onError: undefined,\n  onRequest: undefined,\n  onResponse: undefined,\n} satisfies MiddlewareOptions;\n","// src/express/helpers.ts\nimport type { IncomingMessage, ServerResponse } from \"node:http\";\nimport type {\n  Request as ExpressRequest,\n  Response as ExpressResponse,\n} from \"express\";\nimport type { BodyResult, JsonValue } from \"../types.d.ts\";\n\nexport const readBody = (\n  req: ExpressRequest | IncomingMessage,\n): Promise<BodyResult> => {\n  return new Promise((resolve, reject) => {\n    // const contentType = req.headers[\"content-type\"]?.toLowerCase() || \"\";\n\n    let body = \"\";\n    req.on(\"data\", (chunk) => {\n      body += chunk.toString();\n    });\n\n    req.on(\"end\", () => {\n      try {\n        resolve({ contentType: \"application/json\", data: JSON.parse(body) });\n      } catch (_e) {\n        reject(new Error(\"Invalid JSON\"));\n      }\n\n      resolve({ contentType: \"text/plain\", data: body });\n    });\n\n    req.on(\"error\", reject);\n  });\n};\n\nexport const isExpressRequest = (\n  req: IncomingMessage | ExpressRequest,\n): req is ExpressRequest => {\n  return \"originalUrl\" in req;\n};\n\nexport const isExpressResponse = (\n  res: ServerResponse | ExpressResponse,\n): res is ExpressResponse => {\n  return \"json\" in res && \"send\" in res;\n};\n\nexport const getRequestDetails = (\n  request: ExpressRequest | IncomingMessage,\n) => {\n  const rawUrl =\n    (isExpressRequest(request) ? request.originalUrl : request.url) as string;\n  const url = new URL(rawUrl, \"http://localhost\");\n\n  return {\n    url: url.pathname,\n    search: url.search,\n    searchParams: url.searchParams,\n    headers: request.headers,\n    method: request.method,\n  };\n};\n\nexport const getResponseDetails = (\n  response: ExpressResponse | ServerResponse,\n) => {\n  const isResponseSent = response.headersSent ||\n    response.writableEnded;\n\n  const setHeader = (name: string, value: string) => {\n    if (isExpressResponse(response)) {\n      response.header(name, value);\n    } else {\n      response.setHeader(name, value);\n    }\n  };\n\n  const setStatusCode = (code: number) => {\n    if (isExpressResponse(response)) {\n      response.status(code);\n    } else {\n      response.statusCode = code;\n    }\n  };\n\n  const sendResponse = (\n    code: number,\n    output: Record<string, JsonValue>,\n  ) => {\n    setStatusCode(code);\n\n    if (isExpressResponse(response)) {\n      response.send(JSON.stringify(output));\n    } else {\n      response.end(JSON.stringify(output));\n    }\n  };\n\n  return {\n    isResponseSent,\n    setHeader,\n    statusCode: response.statusCode,\n    setStatusCode,\n    sendResponse,\n  };\n};\n","// src/express/createMidleware.ts\nimport type { IncomingMessage, ServerResponse } from \"node:http\";\nimport type {\n  NextFunction,\n  Request as ExpressRequest,\n  Response as ExpressResponse,\n} from \"express\";\nimport type { Connect } from \"vite\";\nimport { scanForServerFiles } from \"../utils.ts\";\nimport { defaultMiddlewareOptions, defaultRPCOptions } from \"../options.ts\";\nimport { getRequestDetails, getResponseDetails, readBody } from \"./helpers.ts\";\nimport { serverFunctionsMap } from \"../utils.ts\";\nimport type { JsonValue } from \"../types.d.ts\";\nimport type { ExpressMiddlewareFn } from \"./types.d.ts\";\n\nlet middlewareCount = 0;\nconst middleWareStack = new Set<string>();\n\nexport const createMiddleware: ExpressMiddlewareFn = (\n  initialOptions = {},\n) => {\n  const {\n    name: middlewareName,\n    rpcPreffix,\n    path,\n    headers,\n    handler,\n    onRequest,\n    onResponse,\n    onError,\n  } = {\n    ...defaultMiddlewareOptions,\n    ...initialOptions,\n  };\n\n  let name = middlewareName;\n  if (!name) {\n    name = \"viteRPCMiddleware-\" + middlewareCount;\n    middlewareCount += 1;\n  }\n  if (middleWareStack.has(name)) {\n    throw new Error(`The middleware name \"${name}\" is already used.`);\n  }\n\n  const middlewareHandler = async (\n    req: IncomingMessage | ExpressRequest,\n    res: ServerResponse | ExpressResponse,\n    next: Connect.NextFunction | NextFunction,\n  ) => {\n    const { url } = getRequestDetails(req);\n    const { sendResponse, setHeader } = getResponseDetails(res);\n    // When serving from production server, it's a good idea to\n    // scan for server files and populate the serverFunctionsMap\n    if (serverFunctionsMap.size === 0) {\n      // Let the utility use its own defaults\n      await scanForServerFiles();\n    }\n    // No need to continue when no handler provided\n    if (!handler) {\n      return next?.();\n    }\n\n    try {\n      // Execute onRequest hook if provided\n      if (onRequest) {\n        await onRequest(req);\n      }\n      // Path matching\n      if (path) {\n        const matcher = typeof path === \"string\" ? new RegExp(path) : path;\n        if (!matcher.test(url || \"\")) return next?.();\n      }\n      // rpcPreffix matching\n      if (rpcPreffix && !url?.startsWith(`/${rpcPreffix}`)) {\n        return next?.();\n      }\n\n      // Set custom headers\n      if (headers) {\n        Object.entries(headers).forEach(([key, value]) => {\n          setHeader(key, value);\n        });\n      }\n\n      // Execute handler if provided\n      if (handler) {\n        await handler(req, res, next);\n        if (onResponse) {\n          await onResponse(res);\n        }\n        return;\n      }\n\n      next?.();\n    } catch (error) {\n      if (onResponse) {\n        await onResponse(res);\n      }\n      if (onError) {\n        onError(error as Error, req, res);\n      } else {\n        console.error(\"Middleware error:\", String(error));\n        sendResponse(500, { error: \"Internal Server Error\" });\n      }\n    }\n  };\n\n  Object.defineProperty(middlewareHandler, \"name\", {\n    value: name,\n  });\n\n  return middlewareHandler;\n};\n\n// Create RPC middleware\nexport const createRPCMiddleware: ExpressMiddlewareFn = (\n  initialOptions = {},\n) => {\n  const options = {\n    ...defaultMiddlewareOptions,\n    rpcPreffix: defaultRPCOptions.rpcPreffix,\n    ...initialOptions,\n  };\n\n  return createMiddleware({\n    ...options,\n    handler: async (\n      req: IncomingMessage | ExpressRequest,\n      res: ServerResponse | ExpressResponse,\n      next: NextFunction | Connect.NextFunction,\n    ) => {\n      const { url } = getRequestDetails(req);\n      const { sendResponse } = getResponseDetails(res);\n      const { rpcPreffix } = options;\n\n      if (!url?.startsWith(`/${rpcPreffix}`)) {\n        return next?.();\n      }\n\n      const functionName = url.replace(`/${rpcPreffix}/`, \"\");\n      const serverFunction = serverFunctionsMap.get(functionName);\n\n      if (!serverFunction) {\n        sendResponse(\n          404,\n          { error: `Function \"${functionName}\" not found` },\n        );\n        return;\n      }\n\n      try {\n        const body = await readBody(req);\n        const args = Array.isArray(body.data) ? body.data : [body.data];\n        const result = await serverFunction.fn(...args) as JsonValue;\n        sendResponse(200, { data: result });\n      } catch (err) {\n        console.error(String(err));\n        sendResponse(500, { error: \"Internal Server Error\" });\n      }\n    },\n  });\n};\n","import type { ConfigEnv, Plugin, ResolvedConfig, ViteDevServer } from \"vite\";\nimport { loadConfigFromFile, mergeConfig, transformWithEsbuild } from \"vite\";\nimport colors from \"picocolors\";\nimport { resolve } from \"node:path\";\nimport process from \"node:process\";\nimport { existsSync } from \"node:fs\";\nimport { getClientModules, scanForServerFiles } from \"./utils.ts\";\nimport { createRPCMiddleware } from \"./express/createMiddleware.ts\";\nimport { defaultRPCOptions } from \"./options.ts\";\nimport type { RpcPluginOptions } from \"./types.d.ts\";\n\n/**\n * Utility to define `vite-uni-rpc` configuration file similar to vite.\n * @param uniConfig a system wide RPC configuration\n */\nconst defineConfig = (uniConfig: Partial<RpcPluginOptions>) => {\n  return mergeConfig(defaultRPCOptions, uniConfig) as RpcPluginOptions;\n};\n\nlet RPCConfig: RpcPluginOptions;\n\n/**\n * Utility to load `vite-uni-rpc` configuration file system wide.\n * @param configFile an optional parameter to specify a file within your project scope\n */\nasync function loadRPCConfig(configFile?: string) {\n  try {\n    const env: ConfigEnv & { root: string } = {\n      command: \"serve\",\n      root: process.cwd(),\n      mode: process.env.NODE_ENV || \"development\",\n    };\n    const defaultConfigFiles = [\n      \"rpc.config.ts\",\n      \"rpc.config.js\",\n      \"rpc.config.mjs\",\n      \"rpc.config.mts\",\n      \".rpcrc.ts\",\n      \".rpcrc.js\",\n    ];\n\n    // If specific config file provided\n    if (configFile) {\n      const configFilePath = resolve(env.root, configFile);\n      if (!existsSync(configFilePath)) {\n        console.warn(\n          `  ${colors.redBright(\"⚠︎\")} The specified RPC config file ${colors.redBright(\n            colors.bold(configFile),\n          )} cannot be found, loading the defaults..`,\n        );\n        RPCConfig = defaultRPCOptions;\n        return defaultRPCOptions as RpcPluginOptions;\n      }\n\n      const result = await loadConfigFromFile(env, configFile);\n      if (result) {\n        console.log(\n          `  ${colors.yellow(\"⚡︎\")} Succesfully loaded your ${colors.green(\n            colors.bold(configFile),\n          )} file!`,\n        );\n        RPCConfig = mergeConfig(\n          {\n            ...defaultRPCOptions,\n            configFile: configFilePath,\n          },\n          result.config,\n        ) as RpcPluginOptions;\n\n        return RPCConfig;\n      }\n      RPCConfig = defaultRPCOptions;\n      return RPCConfig;\n    }\n\n    if (RPCConfig !== undefined) {\n      return RPCConfig;\n    }\n\n    // Try default config files\n    for (const file of defaultConfigFiles) {\n      const configFilePath = resolve(env.root, file);\n      if (!existsSync(configFilePath)) {\n        continue;\n      }\n      const result = await loadConfigFromFile(env, file);\n      if (result) {\n        RPCConfig = mergeConfig(\n          {\n            ...defaultRPCOptions,\n            configFile: configFilePath,\n          },\n          result.config,\n        ) as RpcPluginOptions;\n        console.log(\n          `  ${colors.yellow(\"⚡︎\")} Succesfully loaded ${colors.green(\n            colors.bold(file),\n          )} file`,\n        );\n\n        return RPCConfig;\n      }\n    }\n    // Last call load defaults no matter what\n    console.warn(\n      `  ${colors.yellow(\"⚡︎\")} No RPC config found, loading the defaults..`,\n    );\n    return defaultRPCOptions as RpcPluginOptions;\n  } catch (error) {\n    console.warn(\n      `  ${colors.redBright(\"⚠︎\")} Failed to load RPC config:`,\n      error,\n    );\n    return defaultRPCOptions as RpcPluginOptions;\n  }\n}\n\nfunction rpcPlugin(devOptions: Partial<RpcPluginOptions> = {}) {\n  let options: RpcPluginOptions;\n  let config: ResolvedConfig;\n  let viteServer: ViteDevServer;\n\n  return {\n    name: \"vite-uni-rpc\",\n    enforce: \"pre\",\n    // Plugin methods\n    async configResolved(resolvedConfig) {\n      if (!config) {\n        const uniConfig = await loadRPCConfig();\n        options = mergeConfig(uniConfig, devOptions) as RpcPluginOptions;\n        config = resolvedConfig;\n      }\n    },\n    async buildStart() {\n      // Prepare the server functions\n      // console.log(\"buildStart\", { config, viteServer });\n      if (viteServer) {\n        await scanForServerFiles(config, viteServer);\n      }\n    },\n    async transform(code: string, id: string, ops?: { ssr?: boolean }) {\n      // Only transform files with server functions for client builds\n      if (\n        !code.includes(\"createServerFunction\") || // any other file is unchanged\n        ops?.ssr || // file loaded on server remains unchanged\n        (code.includes(\"createServerFunction\") &&\n          typeof process === \"undefined\") // file loaded in client IS CHANGED\n      ) {\n        return null;\n      }\n\n      const result = await transformWithEsbuild(getClientModules(options), id, {\n        loader: \"js\",\n        target: \"es2020\",\n      });\n\n      return {\n        code: result.code,\n        map: null,\n      };\n    },\n    async configureServer(server) {\n      if (!viteServer) {\n        viteServer = server;\n        const { adapter: _adapter, ...rest } = options;\n        // console.log(\"configureServer\", { config, viteServer });\n\n        // in dev mode we always use express/connect adapter\n        server.middlewares.use(createRPCMiddleware(rest));\n      }\n    },\n  } satisfies Plugin<RpcPluginOptions>;\n}\n\nexport { rpcPlugin as default };\nexport { defineConfig, loadRPCConfig, type RpcPluginOptions };\nexport {};\n"],"mappings":"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"}