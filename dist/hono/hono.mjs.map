{"version":3,"file":"hono.mjs","names":[],"sources":["../../src/options.ts","../../src/hono/helpers.ts","../../src/hono/createMiddleware.ts"],"sourcesContent":["import type {\n  MiddlewareOptions,\n  RpcPluginOptions,\n  ServerFunctionOptions,\n} from \"./types.d.ts\";\n\nexport const defaultServerFnOptions = {\n  contentType: \"application/json\",\n  ttl: 10 * 1000, // 10s\n  invalidateKeys: [],\n} satisfies ServerFunctionOptions;\n\nexport const defaultRPCOptions = {\n  rpcPreffix: \"__rpc\",\n  adapter: \"express\",\n  headers: undefined,\n  onError: undefined,\n  onRequest: undefined,\n  onResponse: undefined,\n} satisfies RpcPluginOptions;\n\nexport const defaultMiddlewareOptions = {\n  // rpcPreffix: defaultRPCOptions.rpcPreffix,\n  rpcPreffix: undefined,\n  path: undefined,\n  headers: {} as Record<string, string>,\n  handler: undefined,\n  onError: undefined,\n  onRequest: undefined,\n  onResponse: undefined,\n} satisfies MiddlewareOptions;\n","// src/hono/helpers.ts\nimport { type ViteDevServer } from \"vite\";\nimport { type HttpBindings } from \"@hono/node-server\";\nimport type { IncomingMessage, ServerResponse } from \"node:http\";\nimport type { Context } from \"hono\";\nimport { createMiddleware } from \"hono/factory\";\nimport type { ContentfulStatusCode } from \"hono/utils/http-status\";\nimport type { BodyResult } from \"../types.d.ts\";\n\n/**\n * Creates a hono compatible middleware for a given vite development server.\n * @see https://github.com/honojs/hono/issues/3162#issuecomment-2331118049\n * @param vite the vite development server\n */\nexport const viteMiddleware = (vite: ViteDevServer) => {\n  return createMiddleware<{ Bindings: HttpBindings }>((c, next) => {\n    return new Promise((resolve) => {\n      // Node.js\n      // @ts-expect-error - NodeJS is different\n      if (typeof Bun === \"undefined\") {\n        vite.middlewares(c.env.incoming, c.env.outgoing, () => resolve(next()));\n        return;\n      }\n\n      // Bun\n      let sent = false;\n      const headers = new Headers();\n      // Polyfill the node:http IncommingMessage and ServerResponse\n      vite.middlewares(\n        {\n          url: new URL(c.req.path, \"http://localhost\").pathname,\n          method: c.req.raw.method,\n          headers: Object.fromEntries(\n            c.req.raw.headers,\n          ),\n        } as IncomingMessage,\n        {\n          setHeader(name, value: string) {\n            headers.set(name, value);\n            return this;\n          },\n          end(body) {\n            sent = true;\n            resolve(\n              // @ts-expect-error - weird\n              c.body(body, c.res.status as ContentfulStatusCode, headers),\n            );\n          },\n        } as ServerResponse,\n        () => sent || resolve(next()),\n      );\n    });\n  });\n};\n\nexport const readBody = async (c: Context): Promise<BodyResult> => {\n  const contentType = c.req.header(\"content-type\")?.toLowerCase() || \"\";\n\n  if (contentType.includes(\"json\")) {\n    const data = await c.req.json();\n    return {\n      contentType: \"application/json\",\n      data,\n    };\n  }\n\n  const text = await c.req.text();\n  return { contentType: \"text/plain\", data: text };\n};\n","// src/hono/createMiddleware.ts\nimport type { Context, Next } from \"hono\";\nimport { createMiddleware as createHonoMiddleware } from \"hono/factory\";\n// import { scanForServerFiles } from \"vite-uni-rpc/server\";\nimport { serverFunctionsMap, scanForServerFiles } from \"vite-uni-rpc/server\";\nimport type { ServerFunction } from \"vite-uni-rpc\";\nimport { defaultMiddlewareOptions, defaultRPCOptions } from \"../options.ts\";\nimport type { HonoMiddlewareFn, HonoMiddlewareOptions } from \"./types.d.ts\";\nimport { readBody } from \"./helpers.ts\";\n\nlet middlewareCount = 0;\nconst middleWareStack = new Set<string>();\n\nexport const createMiddleware: HonoMiddlewareFn = (initialOptions = {}) => {\n  const {\n    name: middlewareName,\n    rpcPreffix,\n    path,\n    headers,\n    handler,\n    onRequest,\n    onResponse,\n    onError,\n  } = Object.assign(\n    {},\n    defaultMiddlewareOptions,\n    initialOptions,\n  ) as HonoMiddlewareOptions;\n\n  let name = middlewareName;\n  if (!name) {\n    name = \"viteRPCMiddleware-\" + middlewareCount;\n    middlewareCount += 1;\n  }\n  if (middleWareStack.has(name)) {\n    throw new Error(`The middleware name \"${name}\" is already used.`);\n  }\n\n  const middlewareHandler = createHonoMiddleware(\n    async (c: Context, next: Next) => {\n      const reqUrl = new URL(c.req.path, \"http://localhost\");\n      const url = reqUrl.pathname;\n\n      if (serverFunctionsMap.size === 0) {\n        await scanForServerFiles();\n      }\n\n      if (!handler) {\n        await next();\n        return;\n      }\n\n      try {\n        if (onRequest) {\n          await onRequest(c);\n        }\n\n        if (path) {\n          const matcher = typeof path === \"string\" ? new RegExp(path) : path;\n          if (!matcher.test(url || \"\")) {\n            await next();\n            return;\n          }\n        }\n\n        if (rpcPreffix && !url?.startsWith(`/${rpcPreffix}`)) {\n          await next();\n          return;\n        }\n\n        if (headers) {\n          Object.entries(headers).forEach(([key, value]) => {\n            c.header(key, value);\n          });\n        }\n\n        if (handler) {\n          const result = await handler(c, next);\n\n          if (onResponse) {\n            await onResponse(c);\n          }\n\n          return result;\n        }\n        await next();\n      } catch (error) {\n        if (onResponse) {\n          await onResponse(c);\n        }\n        if (onError) {\n          await onError(error as Error, c);\n        } else {\n          return c.json({ error: \"Internal Server Error\" }, 500);\n        }\n      }\n    },\n  );\n\n  Object.defineProperty(middlewareHandler, \"name\", {\n    value: name,\n  });\n\n  return middlewareHandler;\n};\n\nexport const createRPCMiddleware: HonoMiddlewareFn = (initialOptions = {}) => {\n  const options = Object.assign(\n    {},\n    defaultMiddlewareOptions,\n    { rpcPreffix: defaultRPCOptions.rpcPreffix },\n    initialOptions,\n  ) as HonoMiddlewareOptions;\n\n  return createMiddleware({\n    ...options,\n    handler: async (c: Context, next: Next) => {\n      const { path } = c.req;\n      const { rpcPreffix } = options;\n\n      if (!rpcPreffix || !path.startsWith(`/${rpcPreffix}`)) {\n        return await next();\n        // return;\n        // return c.json({ error: `Invalid configuration` }, 404);\n      }\n\n      const functionName = path.replace(`/${rpcPreffix}/`, \"\");\n      const serverFunction = serverFunctionsMap.get(functionName);\n\n      if (!serverFunction) {\n        return c.json({ error: `Function \"${functionName}\" not found` }, 404);\n      }\n\n      try {\n        const body = await readBody(c);\n        const controller = new AbortController();\n        c.req.raw.signal.addEventListener(\"abort\", () => {\n          controller.abort();\n        });\n        const args = Array.isArray(body.data) ? body.data : [body.data];\n        const result = await (serverFunction.fn as unknown as ServerFunction)(\n          controller.signal,\n          ...args,\n        );\n        // TO DO: HANDLE cancel + Abort signal\n\n        return c.json({ data: result }, 200);\n      } catch (err) {\n        console.error(String(err));\n        return c.json({ error: \"Internal Server Error\" }, 500);\n      }\n    },\n  });\n};\n"],"mappings":"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"}