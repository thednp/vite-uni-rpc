{"version":3,"file":"fastify.mjs","names":[],"sources":["../../src/options.ts","../../src/fastify/helpers.ts","../../src/fastify/createMiddleware.ts"],"sourcesContent":["import type {\n  MiddlewareOptions,\n  RpcPluginOptions,\n  ServerFunctionOptions,\n} from \"./types.d.ts\";\n\nexport const defaultServerFnOptions = {\n  contentType: \"application/json\",\n  ttl: 10 * 1000, // 10s\n  invalidateKeys: [],\n} satisfies ServerFunctionOptions;\n\nexport const defaultRPCOptions = {\n  rpcPreffix: \"__rpc\",\n  adapter: \"express\",\n  headers: undefined,\n  onError: undefined,\n  onRequest: undefined,\n  onResponse: undefined,\n} satisfies RpcPluginOptions;\n\nexport const defaultMiddlewareOptions = {\n  // rpcPreffix: defaultRPCOptions.rpcPreffix,\n  rpcPreffix: undefined,\n  path: undefined,\n  headers: {} as Record<string, string>,\n  handler: undefined,\n  onError: undefined,\n  onRequest: undefined,\n  onResponse: undefined,\n} satisfies MiddlewareOptions;\n","// vite-uni-rpc/src/fastify/helpers.ts\nimport type { FastifyRequest } from \"fastify\";\nimport type { BodyResult, JsonValue } from \"../types.d.ts\";\n\nexport const readBody = (req: FastifyRequest): Promise<BodyResult> => {\n  return new Promise((resolve, reject) => {\n    const contentType = req.headers[\"content-type\"]?.toLowerCase() || \"\";\n\n    if (contentType.includes(\"json\")) {\n      resolve({\n        contentType: \"application/json\",\n        data: req.body as JsonValue,\n      });\n      return;\n    }\n\n    let body = \"\";\n    req.raw.on(\"data\", (chunk) => {\n      body += chunk.toString();\n    });\n\n    req.raw.on(\"end\", () => {\n      resolve({ contentType: \"text/plain\", data: body });\n    });\n\n    req.raw.on(\"error\", reject);\n  });\n};\n","// src/fastify/createMiddleware.ts\nimport type {\n  FastifyReply,\n  FastifyRequest,\n  HookHandlerDoneFunction,\n} from \"fastify\";\n// import { scanForServerFiles } from \"vite-uni-rpc/server\";\nimport { serverFunctionsMap, scanForServerFiles } from \"vite-uni-rpc/server\";\nimport type { ServerFunction } from \"vite-uni-rpc\";\nimport { defaultMiddlewareOptions, defaultRPCOptions } from \"../options.ts\";\nimport type {\n  FastifyMiddlewareFn,\n  FastifyMiddlewareOptions,\n} from \"./types.d.ts\";\nimport { readBody } from \"./helpers.ts\";\n\nlet middlewareCount = 0;\nconst middleWareStack = new Set<string>();\n\n// Define the middleware function for Fastify\nexport const createMiddleware: FastifyMiddlewareFn = (initialOptions = {}) => {\n  const {\n    name: middlewareName,\n    rpcPreffix,\n    path,\n    headers,\n    handler,\n    onRequest,\n    onResponse,\n    onError,\n  } = Object.assign(\n    {},\n    defaultMiddlewareOptions,\n    initialOptions,\n  ) as FastifyMiddlewareOptions;\n\n  let name = middlewareName;\n  if (!name) {\n    name = \"viteRPCMiddleware-\" + middlewareCount;\n    middlewareCount += 1;\n  }\n  if (middleWareStack.has(name)) {\n    throw new Error(`The middleware name \"${name}\" is already used.`);\n  }\n\n  const middlewareHandler = async (\n    req: FastifyRequest,\n    reply: FastifyReply,\n    done: HookHandlerDoneFunction,\n  ) => {\n    const reqUrl = new URL(req.url, \"http://localhost\");\n    const url = reqUrl.pathname;\n\n    // When serving from production server, scan for server files and populate the serverFunctionsMap\n    if (serverFunctionsMap.size === 0) {\n      await scanForServerFiles();\n    }\n\n    // No need to continue if no handler is provided\n    if (!handler) {\n      done();\n      return;\n    }\n\n    try {\n      // Execute onRequest hook if provided\n      if (onRequest) {\n        await onRequest(req);\n      }\n\n      // Path matching\n      if (path) {\n        const matcher = typeof path === \"string\" ? new RegExp(path) : path;\n        if (!matcher.test(url || \"\")) {\n          done();\n          return;\n        }\n      }\n\n      // rpcPreffix matching\n      if (rpcPreffix && !url?.startsWith(`/${rpcPreffix}`)) {\n        done();\n        return;\n      }\n\n      // Set custom headers\n      if (headers) {\n        Object.entries(headers).forEach(([key, value]) => {\n          reply.header(key, value);\n        });\n      }\n\n      // Execute handler if provided\n      if (handler) {\n        await handler(req, reply, done);\n        if (onResponse) {\n          await onResponse(reply);\n        }\n        return;\n      }\n\n      done();\n    } catch (error) {\n      if (onResponse) {\n        await onResponse(reply);\n      }\n      if (onError) {\n        await onError(error as Error, req, reply);\n      } else {\n        console.error(\"Middleware error:\", String(error));\n        reply.status(500).send({ error: \"Internal Server Error\" });\n      }\n    }\n  };\n\n  Object.defineProperty(middlewareHandler, \"name\", {\n    value: name,\n  });\n\n  return middlewareHandler;\n};\n\nexport const createRPCMiddleware: FastifyMiddlewareFn = (\n  initialOptions = {},\n) => {\n  const options = Object.assign(\n    {},\n    defaultMiddlewareOptions,\n    { rpcPreffix: defaultRPCOptions.rpcPreffix },\n    initialOptions,\n  ) as FastifyMiddlewareOptions;\n\n  return createMiddleware({\n    ...options,\n    handler: async (\n      req: FastifyRequest,\n      reply: FastifyReply,\n      done: HookHandlerDoneFunction,\n    ) => {\n      const reqUrl = new URL(req.url, \"http://localhost\");\n      const url = reqUrl.pathname;\n      const { rpcPreffix } = options;\n\n      if (!url?.startsWith(`/${rpcPreffix}`)) {\n        done();\n        return;\n      }\n\n      const functionName = url.replace(`/${rpcPreffix}/`, \"\");\n      const serverFunction = serverFunctionsMap.get(functionName);\n\n      if (!serverFunction) {\n        reply.status(404).send({\n          error: `Function \"${functionName}\" was not found`,\n        });\n        return;\n      }\n\n      try {\n        const body = await readBody(req);\n        const controller = new AbortController();\n        req.raw.on(\"close\", () => controller.abort());\n        req.raw.on(\"error\", () => controller.abort());\n        const args = Array.isArray(body.data) ? body.data : [body.data];\n        const data = await // the plugin will do the switcharoo\n        (serverFunction.fn as unknown as ServerFunction)(\n          controller.signal,\n          ...args,\n        );\n        // TO DO: HANDLE cancel + Abort signal\n        reply.status(200).send({ data });\n      } catch (err) {\n        console.error(String(err));\n        reply.status(500).send({ error: \"Internal Server Error\" });\n      }\n    },\n  });\n};\n"],"mappings":"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"}